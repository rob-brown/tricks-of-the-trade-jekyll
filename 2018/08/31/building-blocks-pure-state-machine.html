<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Building Blocks: Pure State Machine | Tricks of the Trade</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Building Blocks: Pure State Machine" />
<meta name="author" content="Robert Brown" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Previously I wrote about my most common building block: Agent. Today I’m going to use Agent to make a bigger building block, namely a pure state machine. It’s implementation is inspired by Elm and Andy Matuschak." />
<meta property="og:description" content="Previously I wrote about my most common building block: Agent. Today I’m going to use Agent to make a bigger building block, namely a pure state machine. It’s implementation is inspired by Elm and Andy Matuschak." />
<link rel="canonical" href="/2018/08/31/building-blocks-pure-state-machine.html" />
<meta property="og:url" content="/2018/08/31/building-blocks-pure-state-machine.html" />
<meta property="og:site_name" content="Tricks of the Trade" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-31T04:12:00+00:00" />
<script type="application/ld+json">
{"datePublished":"2018-08-31T04:12:00+00:00","author":{"@type":"Person","name":"Robert Brown"},"dateModified":"2018-08-31T04:12:00+00:00","description":"Previously I wrote about my most common building block: Agent. Today I’m going to use Agent to make a bigger building block, namely a pure state machine. It’s implementation is inspired by Elm and Andy Matuschak.","url":"/2018/08/31/building-blocks-pure-state-machine.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/08/31/building-blocks-pure-state-machine.html"},"headline":"Building Blocks: Pure State Machine","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Tricks of the Trade" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Tricks of the Trade</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about">About</a><a class="page-link" href="/hire-me">Hire Me</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Building Blocks: Pure State Machine</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-08-31T04:12:00+00:00" itemprop="datePublished">Aug 31, 2018
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Robert Brown</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Previously I wrote about my <a href="#posts/building-blocks-agent">most common building block: <code class="language-plaintext highlighter-rouge">Agent</code></a>. Today I’m going to use <code class="language-plaintext highlighter-rouge">Agent</code> to make a bigger building block, namely a pure <a href="https://en.wikipedia.org/wiki/Finite-state_machine">state machine</a>. It’s implementation is inspired by <a href="http://elm-lang.org">Elm</a> and <a href="https://gist.github.com/andymatuschak/d5f0a8730ad601bcccae97e8398e25b2">Andy Matuschak</a>.</p>

<p>Before continuing, note that “pure” means the state machine is mathematically pure. Or in other words given the same outputs it will <em>always</em> produce the same outputs. This makes testing the state machine trivial.</p>

<p>Let’s start with the basic type definition and constructor.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import Foundation

public final class SimplePureStateMachine&lt;State, Action, Command&gt; {
public typealias ActionHandler = (State, Action) -&gt; (State, Command)

private let state: SimpleAgent&lt;State&gt;
private let handler: ActionHandler

public init(initialState: State, handler: @escaping ActionHandler) {
    self.state = SimpleAgent(state: initialState)
    self.handler = handler
}
}
</code></pre></div></div>

<p>The state is stored in the <a href="#posts/building-blocks-agent">agent created previously</a>. This ensures updates are thread safe.</p>

<p>The most notable part of the type definition is <code class="language-plaintext highlighter-rouge">ActionHandler</code>. It’s simply a function. As input, it receives the current state and an action (sometimes called an event or message). The action represents an operation to be performed on the state. I typically implement actions as a Swift <code class="language-plaintext highlighter-rouge">enum</code>. Here’s an example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public enum BluetoothAction {
case bluetoothPoweredOn
case bluetoothPoweredOff
case startScan
case stopScan
case scanTimedOut
}
</code></pre></div></div>

<p>As output, the <code class="language-plaintext highlighter-rouge">ActionHandler</code> returns new state and a command (sometimes called an effect). The command represents any side effects the state machine would like performed on its behalf. Since the state machine is pure, it can’t do things like performing network requests or access a database. Some external entity will receive the commands, perform them, and report back to the state machine with an action.</p>

<p>For those interested, this type of state machine is known as a <a href="https://en.wikipedia.org/wiki/Finite-state_machine#Transducers">Mealy machine</a>.</p>

<p>Now that you are thoroughly lost in the theory, let’s actually implement the rest of the state machine. It turns out there is only one function left to implement: <code class="language-plaintext highlighter-rouge">handleAction</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public func handleAction(_ action: Action) -&gt; Command {
return state.fetchAndUpdate {
    let (newState, command) = self.handler($0, action)
    return (command, newState)
}
}
</code></pre></div></div>

<p>That’s it. All the real work is done by <code class="language-plaintext highlighter-rouge">SimpleAgent</code> and the <code class="language-plaintext highlighter-rouge">ActionHandler</code>. This leaves <code class="language-plaintext highlighter-rouge">SimplePureStateMachine</code> weighing in at a whopping 24 lines, including blank lines.</p>

<p>Before I conclude, I’ll demonstrate <code class="language-plaintext highlighter-rouge">SimplePureStateMachine</code>. That will help clear up the mystery behind <code class="language-plaintext highlighter-rouge">ActionHandler</code>. For this example, I will make a simple coin-operated turnstile.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>enum TurnstileState {
case locked
case unlocked
}

enum TurnstileAction {
case insertToken
case admitPerson
}

enum TurnstileCommand {
case lock
case unlock
case ejectToken
case notifySecurity
}

let turnstile = SimplePureStateMachine&lt;TurnstileState, TurnstileAction, TurnstileCommand&gt;(initialState: .locked) { state, action in
switch (state, action) {
case (.locked, .insertToken):
    return (.unlocked, .unlock)

case (.locked, .admitPerson):
    return (.locked, .notifySecurity)

case (.unlocked, .admitPerson):
    return (.locked, .lock)

case (.unlocked, .insertToken):
    return (.unlocked, .ejectToken)
}
}

turnstile.handleAction(.insertToken)   // Command: unlock
turnstile.handleAction(.admitPerson)   // Command: lock
turnstile.handleAction(.admitPerson)   // Command: notifySecurity
turnstile.handleAction(.insertToken)   // Command: unlock
turnstile.handleAction(.insertToken)   // Command: ejectToken
</code></pre></div></div>

<p>Again, the great win with a pure state machine is the logic can be tested without any side effects such as inadvertedly alerting security. Also, the state machine doesn’t care how the side effects are implemented. This leaves us free to change that detail however and whenever we want without chaning the state machine. Now that’s modularity.</p>

  </div><a class="u-url" href="/2018/08/31/building-blocks-pure-state-machine.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Tricks of the Trade</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Tricks of the Trade</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/rob-brown"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">rob-brown</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Writing about best development practices and other topics.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
